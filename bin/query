#!/bin/bash

if [ -x "$(command -v column)" ]; then
  FORMATTER="column -s, -t"
else
  FORMATTER="cat"
fi



if [ $# -eq 0 ]; then
  echo "usage: $0 file"
  exit
fi

FILE=$1
shift

if [ ! -f "$FILE" ]; then
 echo "$FILE does not exist or is not a file"
 exit
fi

#OUTPUT_FORMAT=object
#OUTPUT_FORMAT=array
#OUTPUT_FORMAT=objectLines
#OUTPUT_FORMAT=arrayLines
OUTPUT_FORMAT=csv

SQL=$(cat <<EOF
{
  "query" : "$(cat $FILE | tr "\n" " " | sed -e 's/\"/\\\"/g')",
  "resultFormat" : "$OUTPUT_FORMAT",
  "header" : true
}
EOF
)

echo ""
cat $FILE
echo ""
echo ""
curl -s -X POST -H "Content-Type:application/json" -d "$SQL" http://localhost:8888/druid/v2/sql/ | $FORMATTER



#curl -s -X POST -H "Content-Type:application/json" -d "$SQL" http://localhost:8888/druid/v2/sql/ | $FORMATTER
#curl -s -X POST -H "Content-Type:application/json" -d "$SQL" http://localhost:8888/druid/v2/sql/ | jq -r '.[] | [.USER_REWARD] | @csv' | awk -v FS="," 'BEGIN{print "ID\tName";print "============"}{printf "%s\t%s%s",$1,$2,ORS}'